name: Build GKI Kernel

on:
  workflow_dispatch:
    inputs:
      GKI_DEV:
        description: 'GKI kernel branch, e.g., android14-6.1-2024-10'
        required: true
        default: 'android14-6.1-2024-10'
      SUKUSU:
        description: 'Enable SukiSU Ultra?'
        required: true
        default: 'y'
        type: choice
        options:
          - y
          - n
      APPLY_SSG:
        description: 'Enable SSG IO scheduler?'
        required: true
        default: 'n'
        type: choice
        options:
          - y
          - n
      APPLY_SUSFS:
        description: 'Enable SUSFS?'
        required: true
        default: 'y'
        type: choice
        options:
          - y
          - n
      APPLY_KPM:
        description: 'Enable KPM?'
        required: true
        default: 'y'
        type: choice
        options:
          - y
          - n
      APPLY_BETTERNET:
        description: 'Enable network enhancements?'
        required: true
        default: 'y'
        type: choice
        options:
          - y
          - n
      APPLY_BBR:
        description: 'Enable BBR congestion control?'
        required: true
        default: 'd'
        type: choice
        options:
          - y
          - n
          - d

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment variables
      run: |
        echo "GKI_DEV=${{ github.event.inputs.GKI_DEV }}" >> $GITHUB_ENV
        echo "SUKUSU=${{ github.event.inputs.SUKUSU }}" >> $GITHUB_ENV
        echo "APPLY_SSG=${{ github.event.inputs.APPLY_SSG }}" >> $GITHUB_ENV
        echo "APPLY_SUSFS=${{ github.event.inputs.APPLY_SUSFS }}" >> $GITHUB_ENV
        echo "APPLY_KPM=${{ github.event.inputs.APPLY_KPM }}" >> $GITHUB_ENV
        echo "APPLY_BETTERNET=${{ github.event.inputs.APPLY_BETTERNET }}" >> $GITHUB_ENV
        echo "APPLY_BBR=${{ github.event.inputs.APPLY_BBR }}" >> $GITHUB_ENV

    - name: Build kernel
      run: bash local/build.sh

    - name: Upload kernel zip
      uses: actions/upload-artifact@v4
      with:
        name: kernel
        path: common/out/kernel.zip
